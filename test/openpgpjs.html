<!--
 * ***** BEGIN LICENSE BLOCK *****
 * OpenPGP Zimbra Secure is the open source digital signature and encrypt for Zimbra Collaboration Open Source Edition software
 * Copyright (C) 2016-present iWay Vietnam - http://www.iwayvietnam.com

 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * any later version.

 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>
 * ***** END LICENSE BLOCK *****
 *
 * OpenPGP MIME Secure Email Zimlet
 *
 * Written by Nguyen Van Nguyen <nguyennv1981@gmail.com>
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML+RDFa 1.0//EN"
    "http://www.w3.org/MarkUp/DTD/xhtml-rdfa-1.dtd">
<html amp xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" version="XHTML+RDFa 1.0" dir="ltr"
    xmlns:og="http://ogp.me/ns#"
    xmlns:article="http://ogp.me/ns/article#"
    xmlns:book="http://ogp.me/ns/book#"
    xmlns:profile="http://ogp.me/ns/profile#"
    xmlns:video="http://ogp.me/ns/video#"
    xmlns:product="http://ogp.me/ns/product#"
    xmlns:content="http://purl.org/rss/1.0/modules/content/"
    xmlns:dc="http://purl.org/dc/terms/"
    xmlns:foaf="http://xmlns.com/foaf/0.1/"
    xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
    xmlns:sioc="http://rdfs.org/sioc/ns#"
    xmlns:sioct="http://rdfs.org/sioc/types#"
    xmlns:skos="http://www.w3.org/2004/02/skos/core#"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema#">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>OpenPGP Message Test</title>
<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript" src="ready.min.js"></script>
<script type="text/javascript" src="AjxUtil.js"></script>
<script type="text/javascript" src="ZmMimeTable.js"></script>
<script type="text/javascript" src="AjxCallback.js"></script>
<script type="text/javascript" src="AjxStringUtil.js"></script>

<script type="text/javascript" src="../openpgp_zimbra_secure/js/punycode/punycode.js"></script>
<script type="text/javascript" src="../openpgp_zimbra_secure/js/emailjs/emailjs-addressparser.js"></script>
<script type="text/javascript" src="../openpgp_zimbra_secure/js/emailjs/emailjs-stringencoding.js"></script>
<script type="text/javascript" src="../openpgp_zimbra_secure/js/emailjs/emailjs-mime-types.js"></script>
<script type="text/javascript" src="../openpgp_zimbra_secure/js/emailjs/emailjs-mime-codec.js"></script>
<script type="text/javascript" src="../openpgp_zimbra_secure/js/emailjs/emailjs-mime-parser.js"></script>
<script type="text/javascript" src="../openpgp_zimbra_secure/js/emailjs/emailjs-mime-builder.js"></script>

<script type="text/javascript" src="../openpgp_zimbra_secure/js/openpgpjs/openpgp.min.js"></script>
<script type="text/javascript" src="../openpgp_zimbra_secure/js/OpenPGPMimeBuilder.js"></script>
<script type="text/javascript" src="../openpgp_zimbra_secure/js/OpenPGPEncrypt.js"></script>
<script type="text/javascript" src="../openpgp_zimbra_secure/js/OpenPGPDecrypt.js"></script>
<script type="text/javascript" src="../openpgp_zimbra_secure/js/OpenPGPUtils.js"></script>

<script type="text/javascript">
<!--//--><![CDATA[//><!--
    var formatPEM = function(pem) {
        var length = pem.length;
        var result = '';

        for(var i = 0, count = 0; i < length; i++, count++) {
            if(count > 75) {
                result = result + "\r\n";
                count = 0;
            }

            result = result + pem[i];
        }

        return result;
    };

    var defineMessage = function() {
        var contents = [], attachments = [];
        var cid = 'j1ohjwj40.15b847f10fa1414d@openpgp';

        contents.push({
            ct: 'text/plain; charset=utf-8',
            content: {
                _content: 'Test signed formatted message with attachment'
            }
        });
        contents.push({
            ct: 'text/html; charset=utf-8',
            content: {
                _content: '<strong>Test signed formatted message with attachment</strong>\n<img src="cid:' + cid + '" alt="">'
            }
        });

        attachments.push({
            ct: 'image/png; name=valid.png',
            cd: 'attachment',
            ci: '<' + cid + '>',
            data: formatPEM('iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAvVBMVEUAAAAPug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug8Pug/2MSuoAAAAPnRSTlMAAQMEBQYHCQoLDA0QEhQZHyAiIyQmKSwzNDU4Q0RFUVtoc3eFiYuqtLW3vsHFx8zP0dPV2dze4Ojv9fn7/Z3mkNsAAACTSURBVBgZBcGHIhsAAEDBVyE2JWLPmm1V7ZW4//8sd1Ud/MHH+XJVNbwBfB1WNfsGwGnVNQD8rC0Ad3uv7uoC4N+gJVZ65nj8ye2gRuw28avWP//O1MaEw148zNXaTG1Osd8V93NVoymsto3HYY2ncF/9xtPizhcYV8N3AM6qWrgFOKmqfhz9x+RytaqqGizNV1XfgD0jxoFnSPoAAAAASUVORK5CYII=')
        });
        attachments.push({
            ct: 'image/png; name=corrupt.png',
            cd: 'attachment',
            data: formatPEM('iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAApVBMVEUAAAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAB0VaXZAAAANnRSTlMAAQIDBQwNExQZGh0eHyAjKSorLS4wMTRRUlhwgIOOlZeYm7m6wMzOz9HZ2t7g6Ont8fX3+fstoyDcAAAAh0lEQVQYGQXBhyICAABAwVcysmc2mSEj4f7/09xVtX75sHiZngyqquEN4H1c1fAZV2fnXzisuoWNesJytXbAuGYwrWuwXXMw6g3s1SfY6hfs1w84aA4mBWx1Df6+l8CoXXBa4K66g+OC5Vq1MsP92QUcVTW8AXxsVlWtXz4uXqeTQVVVVVVV/5JEH13hQwyRAAAAAElFTkSuQmCC')
        });

        return {
            contents: contents,
            attachments: attachments
        };
    };

    domready(function() {
        openpgp.initWorker({
            path: '../openpgp_zimbra_secure/js/openpgpjs/openpgp.worker.min.js'
        });

        var privateKey = false;
        var publicKey  = false;
        var passphrase = OpenPGPUtils.randomString();

        var opts = {
            data: 'hJP2EBpHjKEdpepiyUtntlcW',
            passwords: ['abc@123'],
            armor: true
        };
        openpgp.encrypt(opts).then(function(ciphertext) {
            return ciphertext.data;
        })
        .then(function(encrypted) {
            var opts = {
                message: openpgp.message.readArmored(encrypted),
                password: 'abc@123'
            };
            openpgp.decrypt(opts).then(function(plaintext) {
                return plaintext.data;
            });
        });

        var sequence = Promise.resolve(defineMessage());
        sequence.then(function(message) {
            var opts = {
                userIds: [
                    { name: 'Nguyen Van Nguyen', email: 'nguyennv1981@gmail.com' },
                    { name: 'Nguyen Van Nguyen', email: 'nguyennv1981@yahoo.com' },
                ],
                numBits: 2048,
                passphrase: passphrase
            };
            return openpgp.generateKey(opts).then(function(key) {
                privateKey = openpgp.key.readArmored(key.privateKeyArmored).keys[0];
                privateKey.decrypt(passphrase);
                publicKey = openpgp.key.readArmored(key.publicKeyArmored).keys[0];
                return {
                    message: message,
                    privateKey: privateKey,
                    publicKey: publicKey
                };
            });
        })
        .then(function(result) {
            var encryptor = new OpenPGPEncrypt({
                privateKey: result.privateKey,
                publicKeys: [result.publicKey],
                beforeEncrypt: function(mimeNode) {
                    $('#mime-message').text(mimeNode.build());
                },
                onEncrypted: function(mimeNode) {
                    mimeNode.addHeader('Subject', 'Giá trị của một quốc gia không phải được xác định bằng của cải mà bằng các tiêu chuẩn đạo đức, dân chủ, văn minh và văn hóa.');
                    $('#signed-message').text(mimeNode.build());
                },
                onError: function(error) {
                    console.log(error);
                }
            });
            encryptor.shouldSign(true);
            encryptor.shouldEncrypt(false);
            return encryptor.encrypt(result.message.contents, result.message.attachments).then(function(mimeNode) {
                result.mimeNode = mimeNode;
                return result;
            });
        })
        .then(function(result) {
            var decryptor = new OpenPGPDecrypt({
                privateKey: result.privateKey,
                publicKeys: [result.publicKey],
                onDecrypted: function(message) {
                    if (message.signatures) {
                        var verify = '';
                        message.signatures.forEach(function(signature) {
                            if (signature.valid) {
                                verify += 'Good signature from ' + signature.userid + '\n';
                            }
                            else {
                                verify += 'Bad signature from ' + signature.userid + '\n';
                            }
                        });
                        $('#openpgp-verify').text(verify);
                    }
                },
                onError: function(error) {
                    console.log(error);
                }
            });
            return decryptor.decrypt(result.mimeNode.build()).then(function(message) {
                return result;
            });
        })
        .then(function(result) {
            var encryptor = new OpenPGPEncrypt({
                privateKey: result.privateKey,
                publicKeys: [result.publicKey],
                onEncrypted: function(mimeNode) {
                    mimeNode.addHeader('Subject', 'ATOK Passport お申し込み完了＆ユーザー登録完了（定額利用サービス）');
                    $('#encrypted-message').text(mimeNode.build());
                },
                onError: function(error) {
                    console.log(error);
                }
            });
            encryptor.shouldSign(true);
            encryptor.shouldEncrypt(true);
            return encryptor.encrypt(result.message.contents, result.message.attachments).then(function(mimeNode) {
                result.mimeNode = mimeNode;
                return result;
            });
        })
        .then(function(result) {
            var decryptor = new OpenPGPDecrypt({
                privateKey: result.privateKey,
                publicKeys: [result.publicKey],
                onDecrypted: function(message) {
                    $('#decrypted-message').text(message.content);
                    if (message.signatures) {
                        var result = '';
                        message.signatures.forEach(function(signature) {
                            if (signature.valid) {
                                result += 'Good signature from ' + signature.userid + '\n';
                            }
                            else {
                                result += 'Bad signature from ' + signature.userid + '\n';
                            }
                        });
                        $('#openpgp-decrypted').text(result);
                    }
                },
                onError: function(error) {
                    console.log(error);
                }
            });
            return decryptor.decrypt(result.mimeNode.build());
        });
    });
//--><!]]>
</script>
</head>
<body>
    <h2>Mime Message</h2>
    <pre id="mime-message"></pre>
    <h2>OpenPGP Signed Message</h2>
    <pre id="signed-message"></pre>
    <h2>Verify Result:</h2>
    <pre id="openpgp-verify"></pre>
    <h2>OpenPGP Encrypted Message</h2>
    <pre id="encrypted-message"></pre>
    <h2>OpenPGP Decrypted Message</h2>
    <pre id="decrypted-message"></pre>
    <h2>Decrypted Result:</h2>
    <span id="openpgp-decrypted"></span>
</body>
</html>
